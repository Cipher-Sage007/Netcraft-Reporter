<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Netcraft Reporter - Web Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // Main App Component
    function App() {
      const [activeTab, setActiveTab] = useState('submit');
      const [config, setConfig] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        loadConfig();
      }, []);

      const loadConfig = async () => {
        try {
          const res = await fetch('/api/config');
          const data = await res.json();
          setConfig(data);
        } catch (error) {
          console.error('Error loading config:', error);
        } finally {
          setLoading(false);
        }
      };

      if (loading) {
        return (
          <div className="container">
            <div className="card">
              <div className="loading">
                <div className="spinner"></div>
                <p>Loading...</p>
              </div>
            </div>
          </div>
        );
      }

      const needsConfig = !config?.hasSupabaseConfig || !config?.email;

      return (
        <div className="container">
          {needsConfig && (
            <div className="alert-banner">
              <span className="alert-icon">‚ö†Ô∏è</span>
              <span>Configuration required! Please go to the <strong>Configuration</strong> tab to set up your email and Supabase database.</span>
            </div>
          )}

          <div className="card">
            <div className="header-section">
              <h1>Netcraft Reporter</h1>
              <p>Report malicious URLs and track their analysis status</p>
            </div>

            <div className="tabs">
              <button
                className={`tab ${activeTab === 'submit' ? 'active' : ''}`}
                onClick={() => setActiveTab('submit')}
              >
                <span className="tab-icon">‚ñ∂</span> Submit URLs
              </button>
              <button
                className={`tab ${activeTab === 'submissions' ? 'active' : ''}`}
                onClick={() => setActiveTab('submissions')}
              >
                <span className="tab-icon">üëÅ</span> View Submissions
              </button>
              <button
                className={`tab ${activeTab === 'config' ? 'active' : ''}`}
                onClick={() => setActiveTab('config')}
              >
                <span className="tab-icon">‚öô</span> Configuration
              </button>
            </div>

            {activeTab === 'submit' && <SubmitTab config={config} needsConfig={needsConfig} />}
            {activeTab === 'submissions' && <SubmissionsTab config={config} />}
            {activeTab === 'config' && <ConfigTab config={config} onUpdate={loadConfig} />}
          </div>
        </div>
      );
    }

    // Submit Tab Component
    function SubmitTab({ config }) {
      const [urls, setUrls] = useState('');
      const [submitting, setSubmitting] = useState(false);
      const [progress, setProgress] = useState(null);
      const [result, setResult] = useState(null);
      const [socket, setSocket] = useState(null);
      const [dragOver, setDragOver] = useState(false);

      useEffect(() => {
        const newSocket = io();
        setSocket(newSocket);

        return () => newSocket.close();
      }, []);

      const processFile = async (file) => {
        const formData = new FormData();
        formData.append('file', file);

        try {
          const res = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });

          const data = await res.json();
          if (data.success) {
            setUrls(data.urls.join('\n'));
          }
        } catch (error) {
          alert('Error uploading file: ' + error.message);
        }
      };

      const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        await processFile(file);
      };

      const handleDragEnter = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragOver(true);
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragOver(false);
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      const handleDrop = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragOver(false);

        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        const file = files[0];
        if (!file.name.endsWith('.txt')) {
          alert('Please upload a .txt file');
          return;
        }

        await processFile(file);
      };

      const handleSubmit = async () => {
        const urlList = urls.split('\n')
          .map(u => u.trim())
          .filter(u => u); // Accept all non-empty lines, validation happens on server

        if (urlList.length === 0) {
          alert('Please enter at least one URL');
          return;
        }

        setSubmitting(true);
        setProgress({ stage: 'starting', message: 'Starting...', progress: 0 });
        setResult(null);

        try {
          const res = await fetch('/api/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls: urlList })
          });

          const data = await res.json();

          if (data.success) {
            // Join socket room for progress updates
            socket.emit('join-job', data.jobId);

            socket.on('progress', (progressData) => {
              setProgress(progressData);
            });

            socket.on('complete', (resultData) => {
              setResult(resultData);
              setSubmitting(false);
              setProgress(null);
            });

            socket.on('rate-limit', (rateLimitData) => {
              // Show rate limit warning
              setProgress({
                stage: 'rate-limit',
                message: `‚ö†Ô∏è ${rateLimitData.message}`,
                progress: 100
              });
            });

            socket.on('error', (errorData) => {
              alert('Error: ' + errorData.message);
              setSubmitting(false);
              setProgress(null);
            });
          } else {
            alert('Error: ' + data.error);
            setSubmitting(false);
          }
        } catch (error) {
          alert('Error: ' + error.message);
          setSubmitting(false);
          setProgress(null);
        }
      };

      const needsConfig = !config?.hasSupabaseConfig || !config?.email;

      return (
        <div>
          <h2>Submit URLs to Netcraft</h2>

          {result && (
            <div className={`alert ${result.rateLimitReached ? 'error' : 'success'}`}>
              {result.rateLimitReached ? (
                <>
                  ‚ö†Ô∏è <strong>Rate Limit Reached!</strong><br/>
                  {result.message}<br/><br/>
                  <strong>Summary:</strong><br/>
                  ‚Ä¢ Total URLs: {result.total}<br/>
                  ‚Ä¢ Successfully Reported: {result.reported}<br/>
                  ‚Ä¢ Skipped (already reported): {result.skipped}<br/>
                  ‚Ä¢ Failed (rate limited): {result.failed}<br/>
                  {result.invalid > 0 && <span>‚Ä¢ Invalid URLs: {result.invalid}<br/></span>}
                  <br/>
                  <em>Please try again after some time to submit the remaining URLs.</em>
                </>
              ) : (
                <>
                  ‚úÖ Successfully processed {result.total} URLs<br/>
                  ‚Ä¢ Reported: {result.reported}<br/>
                  ‚Ä¢ Skipped: {result.skipped}<br/>
                  ‚Ä¢ Failed: {result.failed}<br/>
                  {result.invalid > 0 && <span>‚Ä¢ Invalid: {result.invalid}</span>}
                </>
              )}
            </div>
          )}

          <div className="form-group">
            <label>Paste URLs (one per line)</label>
            <textarea
              value={urls}
              onChange={(e) => setUrls(e.target.value)}
              placeholder="https://example.com&#10;https://phishing-site.com&#10;https://malicious-url.com"
              disabled={submitting}
            />
          </div>

          <div
            className={`file-upload ${dragOver ? 'drag-over' : ''}`}
            onClick={() => !submitting && document.getElementById('file-input').click()}
            onDragEnter={handleDragEnter}
            onDragLeave={handleDragLeave}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
          >
            <input
              id="file-input"
              type="file"
              accept=".txt"
              onChange={handleFileUpload}
              disabled={submitting}
            />
            <div className="upload-icon">‚òÅÔ∏è</div>
            <p><a className="upload-link">{dragOver ? 'Drop your file here!' : 'Click to upload'}</a> or drag and drop a .txt file</p>
            {!dragOver && (
              <p style={{ fontSize: '13px', color: '#718096', marginTop: '8px' }}>
                Supports .txt files with one URL per line
              </p>
            )}
          </div>

          {progress && (
            <div className="progress-container">
              <div className="progress-bar">
                <div
                  className={`progress-fill ${progress.stage === 'rate-limit' ? 'rate-limit' : ''}`}
                  style={{ width: `${progress.progress}%` }}
                ></div>
              </div>
              <p className={`progress-text ${progress.stage === 'rate-limit' ? 'rate-limit' : ''}`}>
                {progress.stage === 'rate-limit' ? (
                  <>{progress.message}</>
                ) : (
                  <><strong>{progress.stage}:</strong> {progress.message}</>
                )}
              </p>
            </div>
          )}

          <div className="button-group" style={{ marginTop: '24px' }}>
            <button
              className="button"
              onClick={handleSubmit}
              disabled={submitting || needsConfig || !urls.trim()}
            >
              {submitting ? '‚è≥ Processing...' : '‚ñ∂ Submit URLs'}
            </button>
            <button
              className="button button-secondary"
              onClick={() => setUrls('')}
              disabled={submitting}
            >
              Clear
            </button>
          </div>

          {needsConfig && (
            <div className="info-message">
              <span className="info-icon">‚ÑπÔ∏è</span>
              <span>Please configure your email and Supabase settings in the Configuration tab before submitting URLs.</span>
            </div>
          )}
        </div>
      );
    }

    // Date Range Picker Component
    function DateRangePicker({ dateRange, setDateRange, showCalendar, setShowCalendar }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [tempRange, setTempRange] = useState({ start: null, end: null });
      const [isSelecting, setIsSelecting] = useState(false);

      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        return { daysInMonth, startingDayOfWeek, year, month };
      };

      const handleDateClick = (day) => {
        const clickedDate = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);

        if (!isSelecting) {
          // Start selection
          setTempRange({ start: clickedDate, end: null });
          setIsSelecting(true);
        } else {
          // End selection
          if (clickedDate >= tempRange.start) {
            setTempRange({ ...tempRange, end: clickedDate });
          } else {
            setTempRange({ start: clickedDate, end: tempRange.start });
          }
          setIsSelecting(false);
        }
      };

      const handleApply = () => {
        if (tempRange.start && tempRange.end) {
          setDateRange(tempRange);
          setShowCalendar(false);
        }
      };

      const handleClear = () => {
        setTempRange({ start: null, end: null });
        setDateRange({ start: null, end: null });
        setIsSelecting(false);
      };

      const { daysInMonth, startingDayOfWeek, year, month } = getDaysInMonth(currentMonth);
      const today = new Date();

      const isDateInRange = (day) => {
        if (!tempRange.start) return false;
        const date = new Date(year, month, day);
        if (!tempRange.end) return date.getTime() === tempRange.start.getTime();
        return date >= tempRange.start && date <= tempRange.end;
      };

      const isDateSelected = (day) => {
        if (!tempRange.start) return false;
        const date = new Date(year, month, day);
        return (date.getTime() === tempRange.start?.getTime()) ||
               (tempRange.end && date.getTime() === tempRange.end.getTime());
      };

      const formatDateRange = () => {
        if (!dateRange.start || !dateRange.end) return 'üìÖ Select Date Range';
        const start = new Date(dateRange.start).toLocaleDateString();
        const end = new Date(dateRange.end).toLocaleDateString();
        return `üìÖ ${start} - ${end}`;
      };

      return (
        <div className="date-range-picker">
          <div
            className={`date-range-input ${showCalendar ? 'active' : ''}`}
            onClick={() => setShowCalendar(!showCalendar)}
          >
            {formatDateRange()}
          </div>

          {showCalendar && (
            <div className="calendar-popup">
              <div className="calendar-header">
                <button onClick={() => setCurrentMonth(new Date(year, month - 1, 1))}>
                  ‚Üê
                </button>
                <div className="calendar-month">
                  {currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </div>
                <button onClick={() => setCurrentMonth(new Date(year, month + 1, 1))}>
                  ‚Üí
                </button>
              </div>

              <div className="calendar-grid">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                  <div key={day} className="calendar-day-header">{day}</div>
                ))}

                {Array.from({ length: startingDayOfWeek }, (_, i) => (
                  <div key={`empty-${i}`} className="calendar-day other-month"></div>
                ))}

                {Array.from({ length: daysInMonth }, (_, i) => {
                  const day = i + 1;
                  const date = new Date(year, month, day);
                  const isToday = date.toDateString() === today.toDateString();

                  return (
                    <div
                      key={day}
                      className={`calendar-day ${isToday ? 'today' : ''} ${isDateSelected(day) ? 'selected' : ''} ${isDateInRange(day) ? 'in-range' : ''}`}
                      onClick={() => handleDateClick(day)}
                    >
                      {day}
                    </div>
                  );
                })}
              </div>

              <div className="calendar-actions">
                <button className="clear-btn" onClick={handleClear}>Clear</button>
                <button
                  className="apply-btn"
                  onClick={handleApply}
                  disabled={!tempRange.start || !tempRange.end}
                >
                  Apply
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Submissions Tab Component
    function SubmissionsTab({ config }) {
      const [submissions, setSubmissions] = useState([]);
      const [stats, setStats] = useState(null);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterState, setFilterState] = useState('all');
      const [sortBy, setSortBy] = useState('reported_at');
      const [sortDir, setSortDir] = useState('desc');
      const [checking, setChecking] = useState(false);
      const [selectedUrls, setSelectedUrls] = useState([]);
      const [dateRange, setDateRange] = useState({ start: null, end: null });
      const [showCalendar, setShowCalendar] = useState(false);
      const [deleting, setDeleting] = useState(false);

      useEffect(() => {
        loadData();
        const interval = setInterval(loadData, 30000); // Refresh every 30 seconds
        return () => clearInterval(interval);
      }, []);

      const loadData = async () => {
        try {
          const [submissionsRes, statsRes] = await Promise.all([
            fetch('/api/submissions'),
            fetch('/api/stats')
          ]);

          const submissionsData = await submissionsRes.json();
          const statsData = await statsRes.json();

          if (submissionsData.success) {
            setSubmissions(submissionsData.submissions);
          }

          if (statsData.success) {
            setStats(statsData.stats);
          }
        } catch (error) {
          console.error('Error loading data:', error);
        } finally {
          setLoading(false);
        }
      };

      const handleCheckStatuses = async () => {
        setChecking(true);
        try {
          const res = await fetch('/api/check-statuses', { method: 'POST' });
          const data = await res.json();

          if (data.success) {
            alert(`‚úÖ Updated ${data.updated} submissions`);
            loadData();
          }
        } catch (error) {
          alert('Error: ' + error.message);
        } finally {
          setChecking(false);
        }
      };

      const filteredAndSorted = useMemo(() => {
        let filtered = submissions;

        // Filter by state
        if (filterState !== 'all') {
          filtered = filtered.filter(s => s.state === filterState);
        }

        // Filter by search
        if (searchTerm) {
          filtered = filtered.filter(s =>
            s.url.toLowerCase().includes(searchTerm.toLowerCase()) ||
            (s.uuid && s.uuid.toLowerCase().includes(searchTerm.toLowerCase()))
          );
        }

        // Filter by date range
        if (dateRange.start && dateRange.end) {
          filtered = filtered.filter(s => {
            const reportedDate = new Date(s.reported_at);
            const startDate = new Date(dateRange.start);
            const endDate = new Date(dateRange.end);
            endDate.setHours(23, 59, 59, 999); // Include full end date
            return reportedDate >= startDate && reportedDate <= endDate;
          });
        }

        // Sort
        filtered.sort((a, b) => {
          let aVal = a[sortBy];
          let bVal = b[sortBy];

          if (sortBy === 'reported_at') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
          }

          if (sortDir === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        return filtered;
      }, [submissions, searchTerm, filterState, sortBy, sortDir, dateRange]);

      const handleSort = (column) => {
        if (sortBy === column) {
          setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
        } else {
          setSortBy(column);
          setSortDir('desc');
        }
      };

      const handleSelectAll = (e) => {
        if (e.target.checked) {
          // Select all FILTERED URLs only
          const urls = filteredAndSorted.map(s => s.url);
          setSelectedUrls(urls);
        } else {
          setSelectedUrls([]);
        }
      };

      const handleSelectOne = (url) => {
        if (selectedUrls.includes(url)) {
          setSelectedUrls(selectedUrls.filter(u => u !== url));
        } else {
          setSelectedUrls([...selectedUrls, url]);
        }
      };

      const handleDelete = async () => {
        if (selectedUrls.length === 0) {
          alert('Please select URLs to delete');
          return;
        }

        if (!confirm(`Are you sure you want to delete ${selectedUrls.length} URL(s)?`)) {
          return;
        }

        setDeleting(true);
        try {
          const res = await fetch('/api/delete-submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls: selectedUrls })
          });

          const data = await res.json();

          if (data.success) {
            alert(`‚úÖ Deleted ${data.deleted} submissions`);
            setSelectedUrls([]);
            loadData();
          } else {
            alert('Error: ' + data.error);
          }
        } catch (error) {
          alert('Error: ' + error.message);
        } finally {
          setDeleting(false);
        }
      };

      if (loading) {
        return (
          <div className="loading">
            <div className="spinner"></div>
            <p>Loading submissions...</p>
          </div>
        );
      }

      return (
        <div>
          <h2>URL Submissions</h2>

          {stats && (
            <div className="stats-grid">
              <div className="stat-card">
                <h3>Total</h3>
                <div className="value">{stats.total}</div>
              </div>
              <div className="stat-card">
                <h3>Reported</h3>
                <div className="value">{stats.reported}</div>
              </div>
              <div className="stat-card">
                <h3>Completed</h3>
                <div className="value">{stats.completed}</div>
              </div>
              <div className="stat-card">
                <h3>Pending</h3>
                <div className="value">{stats.pending + stats.processing}</div>
              </div>
              <div className="stat-card">
                <h3>Failed</h3>
                <div className="value">{stats.failed}</div>
              </div>
            </div>
          )}

          <div className="button-group" style={{ marginBottom: '24px' }}>
            <button
              className="button"
              onClick={handleCheckStatuses}
              disabled={checking}
            >
              {checking ? '‚è≥ Checking...' : 'üîÑ Check Status Updates'}
            </button>
            <button
              className="button button-secondary"
              onClick={loadData}
            >
              üîÑ Refresh
            </button>
          </div>

          <div className="table-controls">
            <div className="table-actions">
              {selectedUrls.length > 0 && (
                <>
                  <span className="selection-info">
                    {selectedUrls.length} selected
                  </span>
                  <button
                    className="button button-danger"
                    onClick={handleDelete}
                    disabled={deleting}
                  >
                    {deleting ? 'üóëÔ∏è Deleting...' : 'üóëÔ∏è Delete Selected'}
                  </button>
                </>
              )}
            </div>
            <DateRangePicker
              dateRange={dateRange}
              setDateRange={setDateRange}
              showCalendar={showCalendar}
              setShowCalendar={setShowCalendar}
            />
          </div>

          <div className="search-box">
            <input
              type="text"
              placeholder="üîç Search by URL or UUID..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>

          <div className="filter-buttons">
            <button
              className={`filter-btn ${filterState === 'all' ? 'active' : ''}`}
              onClick={() => setFilterState('all')}
            >
              All
            </button>
            <button
              className={`filter-btn ${filterState === 'pending' ? 'active' : ''}`}
              onClick={() => setFilterState('pending')}
            >
              Pending
            </button>
            <button
              className={`filter-btn ${filterState === 'processing' ? 'active' : ''}`}
              onClick={() => setFilterState('processing')}
            >
              Processing
            </button>
            <button
              className={`filter-btn ${filterState === 'no threats' ? 'active' : ''}`}
              onClick={() => setFilterState('no threats')}
            >
              No Threats
            </button>
            <button
              className={`filter-btn ${filterState === 'suspicious' ? 'active' : ''}`}
              onClick={() => setFilterState('suspicious')}
            >
              Suspicious
            </button>
            <button
              className={`filter-btn ${filterState === 'malicious' ? 'active' : ''}`}
              onClick={() => setFilterState('malicious')}
            >
              Malicious
            </button>
            <button
              className={`filter-btn ${filterState === 'failed' ? 'active' : ''}`}
              onClick={() => setFilterState('failed')}
            >
              Failed
            </button>
          </div>

          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th className="checkbox-col">
                    <input
                      type="checkbox"
                      checked={filteredAndSorted.length > 0 && selectedUrls.length === filteredAndSorted.length}
                      onChange={handleSelectAll}
                    />
                  </th>
                  <th onClick={() => handleSort('url')}>
                    URL {sortBy === 'url' && (sortDir === 'asc' ? '‚Üë' : '‚Üì')}
                  </th>
                  <th onClick={() => handleSort('uuid')}>
                    UUID {sortBy === 'uuid' && (sortDir === 'asc' ? '‚Üë' : '‚Üì')}
                  </th>
                  <th onClick={() => handleSort('state')}>
                    State {sortBy === 'state' && (sortDir === 'asc' ? '‚Üë' : '‚Üì')}
                  </th>
                  <th onClick={() => handleSort('reported_at')}>
                    Reported {sortBy === 'reported_at' && (sortDir === 'asc' ? '‚Üë' : '‚Üì')}
                  </th>
                  <th>Tags</th>
                </tr>
              </thead>
              <tbody>
                {filteredAndSorted.length === 0 ? (
                  <tr>
                    <td colSpan="6" style={{ textAlign: 'center', padding: '40px', color: '#718096' }}>
                      No submissions found
                    </td>
                  </tr>
                ) : (
                  filteredAndSorted.map((sub, idx) => (
                    <tr key={idx}>
                      <td>
                        <input
                          type="checkbox"
                          checked={selectedUrls.includes(sub.url)}
                          onChange={() => handleSelectOne(sub.url)}
                        />
                      </td>
                      <td>
                        <div className="url-preview" title={sub.url}>
                          {sub.url}
                        </div>
                      </td>
                      <td>
                        <code style={{ fontSize: '12px', color: '#718096' }}>
                          {sub.uuid ? sub.uuid.substring(0, 12) + '...' : 'N/A'}
                        </code>
                      </td>
                      <td>
                        <span className={`badge ${sub.state === 'failed' ? 'failed' :
                          sub.state === 'pending' ? 'pending' :
                          sub.state === 'processing' ? 'processing' : 'completed'}`}>
                          {sub.state}
                        </span>
                      </td>
                      <td>
                        {new Date(sub.reported_at).toLocaleString()}
                      </td>
                      <td>
                        {sub.tags && sub.tags.length > 0 ? sub.tags.join(', ') : '‚Äî'}
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>

          <p style={{ marginTop: '16px', color: '#718096', fontSize: '14px' }}>
            Showing {filteredAndSorted.length} of {submissions.length} submissions
          </p>
        </div>
      );
    }

    // Config Tab Component
    function ConfigTab({ config, onUpdate }) {
      const [email, setEmail] = useState(config?.email || '');
      const [apiKey, setApiKey] = useState('');
      const [supabaseUrl, setSupabaseUrl] = useState('');
      const [supabaseKey, setSupabaseKey] = useState('');
      const [tableName, setTableName] = useState(config?.tableName || 'netcraft_submissions');
      const [saving, setSaving] = useState(false);
      const [testing, setTesting] = useState(false);
      const [message, setMessage] = useState(null);

      const handleSave = async () => {
        setSaving(true);
        setMessage(null);

        try {
          const res = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              apiKey,
              supabaseUrl,
              supabaseKey,
              tableName
            })
          });

          const data = await res.json();

          if (data.success) {
            setMessage({ type: 'success', text: '‚úÖ Configuration saved successfully!' });
            onUpdate();
          }
        } catch (error) {
          setMessage({ type: 'error', text: '‚ùå Error saving configuration: ' + error.message });
        } finally {
          setSaving(false);
        }
      };

      const handleTestDb = async () => {
        setTesting(true);
        setMessage(null);

        try {
          const res = await fetch('/api/test-db', { method: 'POST' });
          const data = await res.json();

          if (data.success) {
            setMessage({ type: 'success', text: '‚úÖ Database connection successful!' });
          } else {
            setMessage({ type: 'error', text: '‚ùå Database test failed: ' + data.error });
          }
        } catch (error) {
          setMessage({ type: 'error', text: '‚ùå Error testing database: ' + error.message });
        } finally {
          setTesting(false);
        }
      };

      const sqlSetup = `CREATE TABLE netcraft_submissions (
  id BIGSERIAL PRIMARY KEY,
  url TEXT NOT NULL,
  uuid TEXT,
  reported_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  state TEXT NOT NULL DEFAULT 'pending',
  tags TEXT[] DEFAULT '{}',
  error TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for faster queries
CREATE INDEX idx_netcraft_url ON netcraft_submissions(url);
CREATE INDEX idx_netcraft_uuid ON netcraft_submissions(uuid);
CREATE INDEX idx_netcraft_state ON netcraft_submissions(state);
CREATE INDEX idx_netcraft_reported_at ON netcraft_submissions(reported_at);`;

      return (
        <div>
          <h2>Configuration</h2>

          {message && (
            <div className={`alert ${message.type}`}>
              {message.text}
            </div>
          )}

          <div className="form-group">
            <label>Reporter Email Address *</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="your-email@example.com"
            />
            <p style={{ fontSize: '13px', color: '#718096', marginTop: '4px' }}>
              This email will be used to report URLs to Netcraft
            </p>
          </div>

          <div className="form-group">
            <label>Netcraft API Key (Optional)</label>
            <input
              type="password"
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="Leave empty if you don't have an API key"
            />
          </div>

          <hr style={{ margin: '32px 0', border: 'none', borderTop: '2px solid #e2e8f0' }} />

          <h3 style={{ marginBottom: '16px' }}>Supabase Database Configuration</h3>

          <div className="form-group">
            <label>Supabase Project URL *</label>
            <input
              type="url"
              value={supabaseUrl}
              onChange={(e) => setSupabaseUrl(e.target.value)}
              placeholder="https://your-project.supabase.co"
            />
          </div>

          <div className="form-group">
            <label>Supabase Anon Key *</label>
            <input
              type="password"
              value={supabaseKey}
              onChange={(e) => setSupabaseKey(e.target.value)}
              placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
            />
          </div>

          <div className="form-group">
            <label>Table Name</label>
            <input
              type="text"
              value={tableName}
              onChange={(e) => setTableName(e.target.value)}
              placeholder="netcraft_submissions"
            />
          </div>

          <div className="setup-instructions">
            <h3>üìã Supabase Setup Instructions</h3>
            <ol>
              <li>Go to <a href="https://supabase.com" target="_blank" rel="noopener noreferrer">supabase.com</a> and create a new project</li>
              <li>Go to the SQL Editor in your Supabase dashboard</li>
              <li>Copy and run the SQL below to create the required table:</li>
            </ol>
            <div className="sql-box">{sqlSetup}</div>
            <ol start="4">
              <li>Go to Settings ‚Üí API to find your Project URL and anon/public key</li>
              <li>Paste those values in the form above</li>
              <li>Click "Test Database Connection" to verify everything works</li>
              <li>Click "Save Configuration"</li>
            </ol>
          </div>

          <div className="button-group" style={{ marginTop: '24px' }}>
            <button
              className="button"
              onClick={handleSave}
              disabled={saving || !email || !supabaseUrl || !supabaseKey}
            >
              {saving ? '‚è≥ Saving...' : 'üíæ Save Configuration'}
            </button>
            <button
              className="button button-secondary"
              onClick={handleTestDb}
              disabled={testing || !supabaseUrl || !supabaseKey}
            >
              {testing ? '‚è≥ Testing...' : 'üß™ Test Database Connection'}
            </button>
          </div>
        </div>
      );
    }

    // Render App
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
